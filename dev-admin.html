<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SNGR · Panel Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#2F338F; --brand-600:#242870; --bg:#f4f6fb; --card:#fff; --muted:#6b7280; --line:#e5e7eb; --radius:14px;
    }
    *{box-sizing:border-box}
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; background:var(--bg); color:#1f2937}
    header{background:linear-gradient(180deg,var(--brand),var(--brand-600)); color:#fff; padding:18px}
    .wrap{max-width:980px;margin:0 auto;display:flex;align-items:center;gap:12px}
    .container{max-width:980px;margin:20px auto;padding:16px}
    .card{background:var(--card); border-radius:12px; padding:16px; box-shadow:0 10px 25px rgba(17,24,39,.06); border:1px solid var(--line)}
    .row{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    input[type="text"],textarea,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:8px}
    button{background:var(--brand);color:#fff;border:0;padding:10px 12px;border-radius:8px;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:0.95rem}
    .small{font-size:0.85rem;color:var(--muted)}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#f8fafc}
    .ok{color:#065f46;background:#ecfdf5;border-color:#86efac}
    .err{color:#7f1d1d;background:#fef2f2;border-color:#fecaca}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h2>SNGR · Panel Administrador</h2>
  </div>
</header>

<div class="container">
  <div class="card">
    <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
      <div>
        <strong>Administración</strong>
        <div class="small">Habilita participantes de forma individual o masiva</div>
      </div>
      <div style="width:320px">
        <input id="admin-key" type="text" placeholder="ADMIN KEY (temporal)" />
      </div>
    </div>

    <hr style="margin:12px 0">

    <div style="display:grid;grid-template-columns:1fr 320px;gap:12px">
      <div>
        <div class="row">
          <input id="search-cedula" type="text" placeholder="Buscar por cédula..." />
          <button id="btn-search">Buscar</button>
          <button id="btn-refresh">Refrescar lista</button>
        </div>

        <div class="row">
          <button id="btn-enable-selected">Habilitar seleccionados</button>
          <button id="btn-disable-selected">Deshabilitar seleccionados</button>
        </div>

        <div id="table-wrap" style="margin-top:10px" class="card">
          <table id="tbl">
            <thead><tr><th><input id="chk-all" type="checkbox"></th><th>Cédula</th><th>Apellidos</th><th>Nombres</th><th>Estado</th><th>Acción</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div>
        <div class="small">Carga masiva (CSV)</div>
        <textarea id="csv-area" rows="10" placeholder="cedula,apellidos,nombres,modalidad,fecha,horaInicio,horaFin"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btn-upload">Cargar CSV</button>
          <button id="btn-clear">Limpiar</button>
        </div>

        <hr style="margin:12px 0">
        <div class="small">Resultados</div>
        <div id="admin-msg" class="card" style="margin-top:8px;min-height:80px"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* CONFIG: pega aquí la URL del Worker tras desplegar */
const API_URL = "<PON_AQUI_LA_URL_DE_TU_WORKER>";
// Nota: admin usa ADMIN_KEY header. Para pruebas pega la misma clave que defines al desplegar el Worker.
function getAdminKey() { return document.getElementById('admin-key').value.trim(); }

const tblBody = document.querySelector('#tbl tbody');
const adminMsg = document.getElementById('admin-msg');

function showAdmin(text, type='') {
  adminMsg.textContent = text;
  adminMsg.className = 'card ' + (type || '');
}

async function apiAdmin(action, payload = {}) {
  const form = new URLSearchParams();
  form.append('action', action);
  for (const k in payload) form.append(k, payload[k]);
  const res = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Accept': 'application/json', 'x-admin-key': getAdminKey() },
    body: form
  });
  if (!res.ok) throw new Error('Error de red ' + res.status);
  return res.json();
}

async function loadList(q='') {
  try {
    showAdmin('Cargando lista...');
    const data = await apiAdmin('listarParticipantes', { q });
    tblBody.innerHTML = '';
    (data.list || []).forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" data-ced="${p.cedula}"></td>
        <td>${p.cedula}</td>
        <td>${p.apellidos || ''}</td>
        <td>${p.nombres || ''}</td>
        <td><span class="badge ${p.estado_asistencia === 'HABILITADO' ? 'ok':'err'}">${p.estado_asistencia || 'PENDIENTE'}</span></td>
        <td>
          <button data-action="toggle" data-ced="${p.cedula}">${p.estado_asistencia === 'HABILITADO' ? 'Deshabilitar' : 'Habilitar'}</button>
        </td>
      `;
      tblBody.appendChild(tr);
    });
    showAdmin('Lista cargada. Total: ' + (data.list?.length||0));
  } catch (e) {
    console.error(e);
    showAdmin('Error cargando lista: ' + e.message, 'err');
  }
}

document.getElementById('btn-refresh').addEventListener('click', ()=>loadList(''));
document.getElementById('btn-search').addEventListener('click', ()=>loadList(document.getElementById('search-cedula').value.trim()));

document.getElementById('table-wrap').addEventListener('click', async (ev) => {
  const btn = ev.target.closest('button[data-action="toggle"]');
  if (!btn) return;
  const ced = btn.dataset.ced;
  try {
    showAdmin('Procesando...');
    const res = await apiAdmin('toggleHabilitar', { cedula: ced });
    showAdmin(res.message || 'Operación completada');
    await loadList('');
  } catch (e) {
    showAdmin('Error: ' + e.message, 'err');
  }
});

document.getElementById('btn-upload').addEventListener('click', async () => {
  const txt = document.getElementById('csv-area').value.trim();
  if (!txt) return showAdmin('No hay datos para cargar', 'err');
  try {
    showAdmin('Enviando carga masiva...');
    const res = await apiAdmin('cargaMasiva', { csv: txt });
    showAdmin('Carga completa. Procesados: ' + (res.processed || 0) + '. Agregados: ' + (res.added || 0));
    await loadList('');
  } catch (e) {
    showAdmin('Error carga: ' + e.message, 'err');
  }
});

document.getElementById('btn-clear').addEventListener('click', ()=>{ document.getElementById('csv-area').value = ''; });

document.getElementById('chk-all').addEventListener('change', (e)=>{
  const checks = document.querySelectorAll('#tbl tbody input[type="checkbox"]');
  checks.forEach(c=>c.checked = e.target.checked);
});

document.getElementById('btn-enable-selected').addEventListener('click', async ()=>{
  const ceds = Array.from(document.querySelectorAll('#tbl tbody input[type="checkbox"]:checked')).map(i=>i.dataset.ced);
  if (!ceds.length) return showAdmin('No hay seleccionados', 'err');
  try {
    showAdmin('Habilitando ...');
    const res = await apiAdmin('habilitarMultiple', { cedulas: ceds.join(',') });
    showAdmin(res.message || 'Operación finalizada');
    loadList('');
  } catch (e) { showAdmin('Error: ' + e.message, 'err'); }
});

document.getElementById('btn-disable-selected').addEventListener('click', async ()=>{
  const ceds = Array.from(document.querySelectorAll('#tbl tbody input[type="checkbox"]:checked')).map(i=>i.dataset.ced);
  if (!ceds.length) return showAdmin('No hay seleccionados', 'err');
  try {
    showAdmin('Deshabilitando ...');
    const res = await apiAdmin('deshabilitarMultiple', { cedulas: ceds.join(',') });
    showAdmin(res.message || 'Operación finalizada');
    loadList('');
  } catch (e) { showAdmin('Error: ' + e.message, 'err'); }
});

// carga inicial
loadList('');
</script>
</body>
</html>
