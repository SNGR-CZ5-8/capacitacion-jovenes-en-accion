<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SNGR · Panel Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#2F338F; --brand-600:#242870; --bg:#f4f6fb; --card:#fff; --muted:#6b7280; --line:#e5e7eb; --radius:14px;
    }
    *{box-sizing:border-box}
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; background:var(--bg); color:#1f2937}
    header{background:linear-gradient(180deg,var(--brand),var(--brand-600)); color:#fff; padding:18px}
    .wrap{max-width:980px;margin:0 auto;display:flex;align-items:center;gap:12px}
    .container{max-width:980px;margin:20px auto;padding:16px}
    .card{background:var(--card); border-radius:12px; padding:16px; box-shadow:0 10px 25px rgba(17,24,39,.06); border:1px solid var(--line)}
    .row{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    input[type="text"],textarea,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:8px}
    button{background:var(--brand);color:#fff;border:0;padding:10px 12px;border-radius:8px;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:0.95rem}
    .small{font-size:0.85rem;color:var(--muted)}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#f8fafc}
    .ok{color:#065f46;background:#ecfdf5;border-color:#86efac}
    .err{color:#7f1d1d;background:#fef2f2;border-color:#fecaca}
    .login{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h2>SNGR · Panel Administrador</h2>
  </div>
</header>

<div class="container">
  <div class="card">
    <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
      <div>
        <strong>Administración</strong>
        <div class="small">Habilita participantes de forma individual o masiva</div>
      </div>
      <div style="width:320px">
        <!-- LOGIN -->
        <div class="login">
          <input id="adminKey" type="password" placeholder="ADMIN KEY (obligatorio)" />
          <button id="btn-login">Entrar</button>
        </div>
      </div>
    </div>

    <hr style="margin:12px 0">

    <div id="panel" style="display:none">
      <div style="display:grid;grid-template-columns:1fr 320px;gap:12px">
        <div>
          <div class="row">
            <input id="searchCed" type="text" placeholder="Buscar por cédula..." />
            <button id="btn-search">Buscar</button>
            <button id="btn-refresh">Refrescar</button>
          </div>

          <div class="row">
            <button id="btn-enable-selected">Habilitar seleccionados</button>
            <button id="btn-disable-selected">Deshabilitar seleccionados</button>
          </div>

          <div id="table-wrap" class="card" style="margin-top:10px">
            <table id="tbl">
              <thead><tr><th><input id="chk-all" type="checkbox"></th><th>Cédula</th><th>Apellidos</th><th>Nombres</th><th>Estado</th><th>Acción</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div>
          <div class="small">Carga masiva (CSV)</div>
          <textarea id="csvArea" rows="10" placeholder="cedula,apellidos,nombres,modalidad,fecha,horaInicio,horaFin"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btn-upload">Cargar CSV</button>
            <button id="btn-clear">Limpiar</button>
          </div>

          <hr style="margin:12px 0">
          <div class="small">Resultados</div>
          <div id="adminMsg" class="card" style="margin-top:8px;min-height:80px"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
const API_URL = "https://tight-breeze-c893.dylanvillasagua.workers.dev/";

// Helpers
function adminKey() { return document.getElementById('adminKey').value.trim(); }
function setAdminMsg(txt, err) {
  const el = document.getElementById('adminMsg');
  el.textContent = txt;
  el.style.color = err ? '#7f1d1d' : '#065f46';
}

// Generic POST to worker with admin header when provided
async function workerPost(form) {
  const headers = { 'Accept': 'application/json' };
  const key = adminKey();
  if (key) headers['x-admin-key'] = key;
  const res = await fetch(API_URL, { method:'POST', headers, body: form });
  if (!res.ok) throw new Error('Error ' + res.status);
  return res.json();
}

// UI actions
document.getElementById('btn-login').addEventListener('click', () => {
  const key = adminKey();
  if (!key) { alert('Ingresa ADMIN KEY'); return; }
  // intentamos una llamada simple para validar
  const form = new URLSearchParams();
  form.append('action','listarParticipantes');
  workerPost(form).then(()=> {
    document.getElementById('panel').style.display = 'block';
    setAdminMsg('Acceso correcto. Cargando lista...');
    loadList('');
  }).catch(e=>{
    alert('Clave inválida o error: ' + e.message);
  });
});

const tblBody = document.querySelector('#tbl tbody');

async function loadList(q='') {
  try {
    setAdminMsg('Cargando...');
    const form = new URLSearchParams();
    form.append('action','listarParticipantes');
    form.append('q', q);
    const data = await workerPost(form);
    const list = data.list || [];
    tblBody.innerHTML = '';
    list.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" data-ced="${p.cedula}"></td>
        <td>${p.cedula}</td>
        <td>${p.apellidos || ''}</td>
        <td>${p.nombres || ''}</td>
        <td><span class="badge ${p.estado_asistencia === 'HABILITADO' ? 'ok':'err'}">${p.estado_asistencia || 'PENDIENTE'}</span></td>
        <td><button data-ced="${p.cedula}" class="btn-action">${p.estado_asistencia === 'HABILITADO' ? 'Deshabilitar' : 'Habilitar'}</button></td>
      `;
      tblBody.appendChild(tr);
    });
    setAdminMsg('Lista cargada. Total: ' + list.length);
  } catch (e) {
    console.error(e);
    setAdminMsg('Error: ' + e.message, true);
  }
}

document.getElementById('btn-refresh').addEventListener('click', ()=> loadList(''));
document.getElementById('btn-search').addEventListener('click', ()=> loadList(document.getElementById('searchCed').value.trim()));

document.getElementById('table-wrap').addEventListener('click', async (ev) => {
  const btn = ev.target.closest('.btn-action');
  if (!btn) return;
  const ced = btn.dataset.ced;
  try {
    setAdminMsg('Procesando...');
    const form = new URLSearchParams();
    form.append('action','toggleHabilitar');
    form.append('cedula', ced);
    const res = await workerPost(form);
    setAdminMsg(res.message || 'OK');
    loadList('');
  } catch (e) { setAdminMsg('Error: ' + e.message, true); }
});

document.getElementById('btn-upload').addEventListener('click', async () => {
  const txt = document.getElementById('csvArea').value.trim();
  if (!txt) return setAdminMsg('No hay datos', true);
  try {
    setAdminMsg('Enviando...');
    const form = new URLSearchParams();
    form.append('action','cargaMasiva');
    form.append('csv', txt);
    const res = await workerPost(form);
    setAdminMsg('Procesados: ' + (res.processed||0) + '. Agregados: ' + (res.added||0));
    loadList('');
  } catch (e) { setAdminMsg('Error: ' + e.message, true); }
});

document.getElementById('btn-clear').addEventListener('click', ()=> document.getElementById('csvArea').value='');

document.getElementById('chk-all').addEventListener('change', (e) => {
  document.querySelectorAll('#tbl tbody input[type="checkbox"]').forEach(c => c.checked = e.target.checked);
});

document.getElementById('btn-enable-selected').addEventListener('click', async () => {
  const ceds = Array.from(document.querySelectorAll('#tbl tbody input[type="checkbox"]:checked')).map(i=>i.dataset.ced);
  if (!ceds.length) return setAdminMsg('No hay seleccionados', true);
  try {
    setAdminMsg('Habilitando...');
    const form = new URLSearchParams();
    form.append('action','habilitarMultiple');
    form.append('cedulas', ceds.join(','));
    const res = await workerPost(form);
    setAdminMsg(res.message || 'OK');
    loadList('');
  } catch (e) { setAdminMsg('Error: ' + e.message, true); }
});

document.getElementById('btn-disable-selected').addEventListener('click', async () => {
  const ceds = Array.from(document.querySelectorAll('#tbl tbody input[type="checkbox"]:checked')).map(i=>i.dataset.ced);
  if (!ceds.length) return setAdminMsg('No hay seleccionados', true);
  try {
    setAdminMsg('Deshabilitando...');
    const form = new URLSearchParams();
    form.append('action','deshabilitarMultiple');
    form.append('cedulas', ceds.join(','));
    const res = await workerPost(form);
    setAdminMsg(res.message || 'OK');
    loadList('');
  } catch (e) { setAdminMsg('Error: ' + e.message, true); }
});
</script>
</body>
</html>
