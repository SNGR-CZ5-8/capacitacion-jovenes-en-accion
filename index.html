<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNGR ‚Äì Registro de Capacitaci√≥n</title>

    <!-- Estilos originales -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f5f7fb;
        }
        .header {
            background: #1d2d75;
            color: white;
            padding: 20px;
        }
        .card {
            border-radius: 15px;
        }
        .btn-primary {
            background: #1d2d75;
        }
    </style>
</head>
<body>

    <!-- ENCABEZADO -->
    <div class="header text-center">
        <h3>SNGR ‚Äì Registro de Capacitaci√≥n</h3>
        <p>Programa ‚ÄúJ√≥venes en Acci√≥n‚Äù ¬∑ Uso interno</p>
    </div>

    <!-- FORMULARIO -->
    <div class="container mt-4">
        <div class="card shadow p-4">
            <h4>Formulario de Capacitaci√≥n</h4>
            <p>Verifica tu c√©dula para registrar tu asistencia.</p>

            <!-- Campo c√©dula -->
            <label class="mt-3">C√©dula *</label>
            <div class="input-group">
                <input id="cedula" class="form-control" maxlength="10" placeholder="Ingresa tu c√©dula">
                <button class="btn btn-primary" onclick="buscarCedula()">üîç Verificar</button>
            </div>
            <small class="text-muted">Solo n√∫meros ¬∑ 10 d√≠gitos.</small>

            <!-- Mensajes -->
            <div id="mensaje" class="alert mt-3 d-none"></div>

            <!-- Datos encontrados -->
            <div id="datosPersona" class="mt-4 d-none">
                <h5>Datos del Participante</h5>
                <p><b>Apellidos:</b> <span id="txtApellidos"></span></p>
                <p><b>Nombres:</b> <span id="txtNombres"></span></p>

                <hr>

                <label>Tema de Capacitaci√≥n *</label>
                <input id="tema" class="form-control" placeholder="Ej. Gesti√≥n de Riesgos">

                <label class="mt-3">Fecha *</label>
                <input id="fecha" type="date" class="form-control">

                <label class="mt-3">Hora Inicio *</label>
                <input id="horaInicio" type="time" class="form-control">

                <label class="mt-3">Hora Fin *</label>
                <input id="horaFin" type="time" class="form-control">

                <label class="mt-3">Observaci√≥n (Opcional)</label>
                <textarea id="observacion" class="form-control"></textarea>

                <button class="btn btn-success mt-4" onclick="registrar()">Registrar Capacitaci√≥n</button>
            </div>
        </div>
    </div>


<script>
const API = "https://tight-breeze-c893.dylanvillasagua.workers.dev/";

/* ------------------------------
   Buscar c√©dula
-------------------------------*/
async function buscarCedula() {
    const cedula = document.getElementById("cedula").value.trim();
    const msg = document.getElementById("mensaje");

    if (cedula.length !== 10) {
        mostrarMensaje("C√©dula inv√°lida.", "danger");
        return;
    }

    const res = await fetch(API, {
        method: "POST",
        body: JSON.stringify({
            action: "consultarCedula",
            cedula: cedula
        })
    });

    const data = await res.json();

    if (!data.existe) {
        mostrarMensaje("No existe ning√∫n participante con esta c√©dula.", "danger");
        return;
    }

    if (!data.activo) {
        mostrarMensaje("Tu cuenta est√° inactiva. Contacta a un administrador.", "warning");
        return;
    }

    // Mostrar datos
    document.getElementById("txtApellidos").textContent = data.apellidos;
    document.getElementById("txtNombres").textContent = data.nombres;
    document.getElementById("datosPersona").classList.remove("d-none");

    mostrarMensaje("Datos encontrados. Completa el formulario.", "success");
}

/* ------------------------------
   Registrar asistencia
-------------------------------*/
async function registrar() {
    const cedula = document.getElementById("cedula").value.trim();

    const payload = {
        action: "registrarCapacitacion",
        cedula: cedula,
        apellidos: document.getElementById("txtApellidos").textContent,
        nombres: document.getElementById("txtNombres").textContent,
        tema: document.getElementById("tema").value.trim(),
        fecha: document.getElementById("fecha").value,
        horaInicio: document.getElementById("horaInicio").value,
        horaFin: document.getElementById("horaFin").value,
        observacion: document.getElementById("observacion").value.trim()
    };

    const res = await fetch(API, {
        method: "POST",
        body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (data.ok) {
        mostrarMensaje("Registro guardado correctamente.", "success");
        document.getElementById("datosPersona").classList.add("d-none");
    } else {
        mostrarMensaje("Error al registrar.", "danger");
    }
}

/* ------------------------------ */
function mostrarMensaje(texto, tipo) {
    const msg = document.getElementById("mensaje");
    msg.className = "alert alert-" + tipo;
    msg.textContent = texto;
    msg.classList.remove("d-none");
}
</script>

</body>
</html>
